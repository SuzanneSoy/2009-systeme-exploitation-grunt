#include <types.h>
#include <module.h>
#include <interfaceUtilisateur/console/console.h>

MODULE(Console);

/* Cette variable risque d'être utilisée avant l'apel de initConsole(),
 * donc on la déclare à l'extérieur de etatConsole, dont la valeur est
 * indéfinie tant que initConsole n'a pas été apellée. */
static bool _consolePrete;


Console* definirConsoleActive(Console* console) {
	Console* ancienneConsole = etatConsole->consoleActive;
	
	ancienneConsole->x = etatConsole->x;
	ancienneConsole->y = etatConsole->y;
	
	etatConsole->x = console->x;
	etatConsole->y = console->y;
	
	etatConsole->consoleActive = console;
		
	_consolePrete = TRUE;
	return ancienneConsole;
}


CouleurAvAr getConsoleCouleur() {
	CouleurAvAr couleurs;
	couleurs.av = etatConsole->couleurAv;
	couleurs.ar = etatConsole->couleurAr;
	return couleurs;	
}

CouleurAvAr consoleCouleur(Couleur couleurAv, Couleur couleurAr) {
	CouleurAvAr couleurs = getConsoleCouleur();
	
	etatConsole->couleurAv = couleurAv;
	etatConsole->couleurAr = couleurAr;
	
	return couleurs;
}


Position getConsolePosition() {
	Position pos;
	pos.x = etatConsole->x;
	pos.y = etatConsole->y;
	return pos;
}

Position consolePosition(uint32 x, uint32 y) {
	Position pos = getConsolePosition();
	
	if (x >= etatConsole->consoleActive->largeur) {
		x %= etatConsole->consoleActive->largeur;
		y++;
	}
	
	if (y >= etatConsole->consoleActive->hauteur) {
		y %= etatConsole->consoleActive->hauteur;
	}
	
	etatConsole->x = x;
	etatConsole->y = y;
	
	return pos;
}

void consolePositionAvancerX() {
	consolePosition(etatConsole->x + 1, etatConsole->y);
}

void consolePositionAvancerY() {
	consolePosition(etatConsole->x, etatConsole->y + 1);
}


void afficherCaractereCouleurPositionBrut(char caractere, uint32 couleurAv, uint32 couleurAr, uint32 x, uint32 y) {
	etatConsole->consoleActive->fonctionAffichage(caractere, couleurAv, couleurAr, x, y);
	
	consolePositionAvancerX();
	
	consoleCouleur(couleurAv, couleurAr);
}

void afficherCaractereCouleurPosition(char caractere, uint32 couleurAv, uint32 couleurAr, uint32 x, uint32 y) {
	if (caractere == '\n')
		consolePosition(0, etatConsole->y + 1);
	else
		afficherCaractereCouleurPositionBrut(caractere, couleurAv, couleurAr, x, y);
}


void afficherCaractere(char caractere) {
	afficherCaractereCouleurPosition(caractere, etatConsole->couleurAv, etatConsole->couleurAr, etatConsole->x, etatConsole->y);
}

void afficherCaractereBrut(char caractere) {
	afficherCaractereCouleurPositionBrut(caractere, etatConsole->couleurAv, etatConsole->couleurAr, etatConsole->x, etatConsole->y);
}


void afficherCaractereCouleur(char caractere, uint32 couleurAv, uint32 couleurAr) {
	afficherCaractereCouleurPosition(caractere, couleurAv, couleurAr, etatConsole->x, etatConsole->y);
}

void afficherCaractereCouleurBrut(char caractere, uint32 couleurAv, uint32 couleurAr) {
	afficherCaractereCouleurPositionBrut(caractere, couleurAv, couleurAr, etatConsole->x, etatConsole->y);
}


void afficherCaracterePosition(char caractere, uint32 x, uint32 y) {
	afficherCaractereCouleurPosition(caractere, etatConsole->couleurAv, etatConsole->couleurAr, x, y);
}

void afficherCaracterePositionBrut(char caractere, uint32 x, uint32 y) {
	afficherCaractereCouleurPositionBrut(caractere, etatConsole->couleurAv, etatConsole->couleurAr, x, y);
}


void effacerConsole() {
	uint32 x, y;
	consoleCouleur(0xffffffff, 0);
	for (x=0; x < etatConsole->consoleActive->largeur; x++)
		for (y=0; y < etatConsole->consoleActive->hauteur; y++)
			afficherCaracterePosition(' ', x, y);
	consolePosition(0, 0);
}

void afficherChaineZ(char* chaine) {
	while (*chaine)
		afficherCaractere(*(chaine++));
}

void afficherChaine(char* chaine, int longueur) {
	while (longueur-- > 0)
		afficherCaractere(*(chaine++));
}

void afficherEntierVirguleEnDecimal(uint32 entier, int32 nbDecimales) {
	int pos, nbChar = sizeof(int)*4 + 1;
	char chiffres[nbChar];
	
	for (pos = 0; (pos < nbChar) && ((nbDecimales >= 0) || (entier != 0)); nbDecimales--, pos++) {
		if (nbDecimales == 0)
			chiffres[pos++]='.';
		chiffres[pos] = 48 + (entier % 10);
		entier /= 10;
	}
	
	if (pos == 0)
		afficherCaractere('0');
	else
		for (pos--; pos >= 0; pos--)
			afficherCaractere(chiffres[pos]);
}

void afficherEntierEnDecimal(uint32 entier) {
	int pos, nbChar = sizeof(int)*4;
	char chiffres[nbChar];
	
	for (pos = 0; (pos < nbChar) && (entier != 0); pos++) {
		chiffres[pos] = 48 + (entier % 10);
		entier /= 10;
	}
	
	if (pos == 0)
		afficherCaractere('0');
	else
		for (pos--; pos >= 0; pos--)
			afficherCaractere(chiffres[pos]);
}

void afficherEntierEnHexa(uint32 entier) {
	afficherCaractere('0');
	afficherCaractere('x');
	
	int pos, nbChar = sizeof(entier)*2;
	char hexa[nbChar];
	
	for (pos = 0; pos < nbChar; pos++) {
		if ((entier % 16) < 10)
			hexa[pos] = 48 + (entier % 16);
		else
			hexa[pos] = 87 + (entier % 16);
		entier /= 16;
	}
	
	for (pos--; pos >= 0; pos--)
		afficherCaractere(hexa[pos]);
}

void afficherEntierEnBinaire(uint32 entier) {
	int pos = 0;
	for (pos = 0; pos < 32; pos++) {
		if (entier & 0x80000000)
			afficherChaineZ("1");
		else
			afficherChaineZ("0");
		entier = entier << 1;
	}
}


void afficherTableCaracteres() {
	int i;
	for (i = 0; i < 256; i++)
		afficherCaractereBrut(i);
}


void fonctionAffichageVide (char caractere, uint32 couleurAv, uint32 couleurAr, uint32 x, uint32 y) {
	caractere = caractere;
	couleurAv = couleurAv;
	couleurAr = couleurAr;
	x = x;
	y = y;
}

Console consoleVide = {
	.largeur = 80,
	.hauteur = 25,
	.fonctionAffichage = fonctionAffichageVide
};

bool consolePrete() {
	return _consolePrete;
}

void initConsole(void** etat) {
	*etat = etatConsole;
	
	etatConsole->x = 0;
	etatConsole->y = 0;
	etatConsole->couleurAv = 0xffffffff;
	etatConsole->couleurAr = 0x00000000;
	definirConsoleActive(&consoleVide);
	_consolePrete = FALSE;
}

void deinitConsole(void** etat) {
	*etat = NULL;
}
