#include <module.h>
#include <types.h>
#include <temps/temps/temps.h>
#include <pc/pit/pit.h>

#include <interfaceUtilisateur/console/console.h> /* DEBUG */

MODULE(Temps);

DEPENDANCE_MODULE(Temps, Pit);
DEPENDANCE_MODULE(Temps, Console); /* DEBUG */

void gestionnairePit() {
	etatTemps->nanosec += etatTemps->increments;
	etatTemps->debug++;
	if (etatTemps->nanosec >= 1000000000) {
		etatTemps->nanosec -= 1000000000;
		etatTemps->sec++;
		
		Position p = consolePosition(118, 0);
		afficherEntierEnHexa(etatTemps->sec);
		consolePosition(p.x, p.y);
	}
}

void initTemps (void** etat) {
	*etat = etatTemps;
	
	etatTemps->nanosec = 0;
	etatTemps->sec = 0;
	etatTemps->delta = 0;
	etatTemps->etapesDelta = 1;
	etatTemps->increments = definirDelaiCanal(1000000000, 0);
	
	etatTemps->listeEcheancesDate = NULL;
	etatTemps->listeEcheancesDelai = NULL;
	
	definirGestionnairePit(gestionnairePit);
	etatTemps->sec = 0; // TODO : Récupérer depuis la RTC
	etatTemps->nanosec = 0; // TODO : Récupérer depuis la RTC
	
	Position p = consolePosition(118, 0);
	afficherEntierEnHexa(0);
	consolePosition(p.x, p.y);
}

void deinitTemps (void** etat) {
	*etat = NULL;
}
