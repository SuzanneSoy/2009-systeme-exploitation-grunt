#include <module.h>
#include <types.h>
#include <pc/kbc/kbc.h>
#include <pc/irq/irq.h>
#include <pc/io/io.h>
#include <interfaceUtilisateur/console/console.h>

MODULE(Kbc);

DEPENDANCE_MODULE(Kbc, Irq);
DEPENDANCE_MODULE(Kbc, Io);
DEPENDANCE_MODULE(Kbc, Console);

void gestionnaireRequeteInterruptionKbc() {
	etatKbc->gestionnaireClavier(inb(PORT_KBC_SCANCODE));
}

void gestionnaireClavierVide(uint8 scancode) {
	scancode = scancode;
}

void activerClavier() {
	uint8 ppi = inb(PORT_KBC_PPI);
	ppi = ppi & ~0x80;
	outb(PORT_KBC_PPI, ppi);
}

void activerSouris() {
	
}

void desactiverClavier() {
	uint8 ppi = inb(PORT_KBC_PPI);
	ppi = ppi | 0x80;
	outb(PORT_KBC_PPI, ppi);
}

void attenteKbc() {
	/* Attendre un tampon d'entrée vide */
	while ((inb(PORT_KBC_COMMANDE) & 2) == 2);
}

void attenteLectureKbc() {
	/* Attendre un tampon d'entrée plein */
	while ((inb(PORT_KBC_COMMANDE) & 2) != 2);
}

void resetCpu() {
	attenteKbc();
	outb(PORT_KBC_COMMANDE, KBC_DEMMANDE_ECRITURE_CLAVIER);
	
	attenteKbc();
	outb(PORT_KBC_SCANCODE, KBC_RESET_CPU);
}

void definirGestionnaireClavier(GestionnaireClavier gestionnaireClavier) {
	etatKbc->gestionnaireClavier = gestionnaireClavier;
}

void initKbc (void** etat) {
	*etat = etatKbc;
	
	etatKbc->gestionnaireClavier = gestionnaireClavierVide;
	
	definirGestionnaireRequeteInterruption(LIGNE_IRQ_CLAVIER, gestionnaireRequeteInterruptionKbc);
	activerLigneRequeteInterruption(LIGNE_IRQ_CLAVIER);
	
	activerClavier();
}

void deinitKbc (void** etat) {
	*etat = NULL;
}
