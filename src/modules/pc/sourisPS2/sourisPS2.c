#include <module.h>
#include <types.h>
#include <pc/sourisPS2/sourisPS2.h>
#include <pc/idt/idt.h>
#include <pc/irq/irq.h>
#include <pc/kbc/kbc.h>
#include <pc/io/io.h>
#include <interfaceUtilisateur/console/console.h> /* DEBUG */
#include <pc/vesaGraphique/vesaGraphique.h> /* DEBUG */
#include <interfaceUtilisateur/police/police.h> /* DEBUG */
#include <math.h> /* DEBUG */

MODULE(SourisPS2);

DEPENDANCE_MODULE(SourisPS2, Kbc);
DEPENDANCE_MODULE(SourisPS2, Clavier); /* DEBUG */
DEPENDANCE_MODULE(SourisPS2, VesaGraphique); /* DEBUG */


void envoyerCommandeSourisPS2(uint8 commande) {
	/* TODO : ne pas partir dans une attente infinie en cas de bug matériel */
	attenteKbc();
	outb(PORT_KBC_COMMANDE, KBC_DEMMANDE_ECRITURE_SOURIS);
	
	attenteKbc();
	outb(PORT_KBC_COMMANDE_SOURIS, commande);
}

void gestionnairePaquetSourisPS2(uint8 val) {
	etatSourisPS2->paquets[etatSourisPS2->paquet++] = val;
	
	if (((etatSourisPS2->mouseID == 0) && (etatSourisPS2->paquet == 3)) || (etatSourisPS2->paquet >= 4)) {
		etatSourisPS2->paquet = 0;
		etatSourisPS2->etatGestionnaireSourisPS2 = ETAT_GESTIONNAIRE_SOURIS_PS2_ATTENTE;
		
		/* DEBUG */
		//afficherChaineZ(" p");
		//afficherEntierEnHexa(*(uint32*)(void*)&(etatSourisPS2->paquets));
		
		PaquetSourisPS2_1 p1 = CAST_INT_TO_STRUCT(etatSourisPS2->paquets[0], PaquetSourisPS2_1);
		int xsgn = p1.xNegatif ? 0xffffff00 : 0;
		int ysgn = p1.yNegatif ? 0xffffff00 : 0;
		
		if (p1.boutonGauche)
			etatSourisPS2->couleur = 0xffffffff;
		else if (p1.boutonDroite)
			etatSourisPS2->couleur = 0;
		else if (p1.boutonMilieu)
			etatSourisPS2->couleur = 0xff8800ff;
		
		etatSourisPS2->curseur_x += etatSourisPS2->paquets[1] | xsgn;
		etatSourisPS2->curseur_y -= etatSourisPS2->paquets[2] | ysgn;
		etatSourisPS2->curseur_x = clip(etatSourisPS2->curseur_x, 0, 1023);
		etatSourisPS2->curseur_y = clip(etatSourisPS2->curseur_y, 0, 767);
		// setPixel32(etatSourisPS2->curseur_x, etatSourisPS2->curseur_y, etatSourisPS2->couleur);
		policeAfficherCaractereCouleurPosition(0, etatSourisPS2->couleur, 0x00000000, etatSourisPS2->curseur_x, etatSourisPS2->curseur_y);
	}
}

void gestionnaireDialogueSourisPS2(uint8 val) {
	// afficherChaineZ(" gestionnaireDialogueSourisPS2");
	// afficherChaineZ(" r");
	// afficherEntierEnHexa(val); /* DEBUG */
	// afficherChaineZ(" ");
	// afficherEntierEnDecimal(etatSourisPS2->etapeDialogue);
	// afficherChaineZ(" ");
	// afficherEntierEnDecimal(etatSourisPS2->dialogue.longueur);
	// afficherChaineZ(" ");
	
	
	DialogueSourisPS2 dialogue = etatSourisPS2->dialogue;
	int etape;
	uint8  action, valeur;
	uint8* parametre = dialogue.parametre;
	
	
	boucle:
		etape = etatSourisPS2->etapeDialogue++;
		action = dialogue.sequence[etape * 2];
		valeur = dialogue.sequence[etape * 2 + 1];
		
		if (etape >= dialogue.longueur)
			goto fin;
		
		if (action == RECEVOIR) {
			if (val != valeur) {
				etatSourisPS2->etatGestionnaireSourisPS2 = ETAT_GESTIONNAIRE_SOURIS_PS2_ATTENTE;
				dialogue.rappel(TRUE);
				return;
			}
		} else if (action == RECEVOIR_V) {
			*parametre = val;
		} else if (action == RECEVOIR_OU_PAS) {
			if (val != valeur)
				goto boucle;
		}
	/* Fin boucle */
	
	etape = etatSourisPS2->etapeDialogue++;
	while (etape < dialogue.longueur) {
		action = dialogue.sequence[etape * 2];
		valeur = dialogue.sequence[etape * 2 + 1];
		
		if (action == ENVOYER) {
			/* DEBUG */
			// afficherChaineZ(" s");
			// afficherEntierEnHexa(valeur);
			envoyerCommandeSourisPS2(valeur);
		} else if (action == ENVOYER_V) {
			/* DEBUG */
			// afficherChaineZ(" s");
			// afficherEntierEnHexa(*parametre);
			envoyerCommandeSourisPS2(*parametre);
		} else if (action == COMMANDE) {
			attenteKbc();
			outb(PORT_KBC_COMMANDE, valeur);
		} else {
			break;
		}
		etape = etatSourisPS2->etapeDialogue++;
	}
	
	fin:
	if (etape >= dialogue.longueur) {
		etatSourisPS2->etatGestionnaireSourisPS2 = ETAT_GESTIONNAIRE_SOURIS_PS2_ATTENTE;
		dialogue.rappel(FALSE);
	}
}

bool dialoguer(const uint8* sequence, int longueur, uint8* parametre, FonctionRappelSourisPS2 rappel) {
	// afficherChaineZ(" dialoguer");
	desactiverInterruptions();
	
	longueur /= 2;
	
	if (etatSourisPS2->etatGestionnaireSourisPS2 != ETAT_GESTIONNAIRE_SOURIS_PS2_ATTENTE) {
		activerInterruptions();
		return FALSE;
	}
	
	uint8  action, valeur;
	int etape;
	for (etape = 0; etape < longueur; etape++) {
		action = sequence[etape * 2];
		valeur = sequence[etape * 2 + 1];
		
		if (action == ENVOYER) {
			/* DEBUG */
			// afficherChaineZ(" s");
			// afficherEntierEnHexa(valeur);
			envoyerCommandeSourisPS2(valeur);
// afficherChaineZ(" "); afficherEntierEnDecimal(etape); afficherChaineZ(" "); afficherEntierEnDecimal(longueur); afficherChaineZ(" ");
		} else if (action == ENVOYER_V) {
			/* DEBUG */
			// afficherChaineZ(" s");
			// afficherEntierEnHexa(*parametre);
			envoyerCommandeSourisPS2(*parametre);
// afficherChaineZ(" "); afficherEntierEnDecimal(etape); afficherChaineZ(" "); afficherEntierEnDecimal(longueur); afficherChaineZ(" ");
		} else
			break;
	}

	if (etape >= longueur) {
		rappel(FALSE);
	} else {
		etatSourisPS2->dialogue.sequence = sequence;
		etatSourisPS2->dialogue.longueur = longueur;
		etatSourisPS2->dialogue.parametre = parametre;
		etatSourisPS2->dialogue.rappel = rappel;
		etatSourisPS2->etapeDialogue = etape;
		etatSourisPS2->etatGestionnaireSourisPS2 = ETAT_GESTIONNAIRE_SOURIS_PS2_DIALOGUE;
	}
	
	activerInterruptions();
	return TRUE;
}

void gestionnaireSourisPS2() {
	// afficherChaineZ(" gs ");
	uint8 val;
	val = inb(PORT_KBC_SOURIS);
	// afficherEntierEnHexa(val);
	
	switch (etatSourisPS2->etatGestionnaireSourisPS2) {
		case ETAT_GESTIONNAIRE_SOURIS_PS2_ATTENTE :
		case ETAT_GESTIONNAIRE_SOURIS_PS2_PAQUET :
			gestionnairePaquetSourisPS2(val);
			break;
		case ETAT_GESTIONNAIRE_SOURIS_PS2_DIALOGUE :
			gestionnaireDialogueSourisPS2(val);
			break;
	}
}

void fonctionRappelVide(bool erreur) {
	erreur = erreur;
	// afficherChaineZ(" rappel "); /* DEBUG */
	// afficherEntierEnDecimal(erreur);
}


void definirResolution(uint8 res) {
	etatSourisPS2->resolution = res;
	dialoguer(DialogueDefinirResolution, LONGUEUR(DialogueDefinirResolution), &(etatSourisPS2->resolution), fonctionRappelVide);
}

void demanderPaquet() {
	// afficherChaineZ(" demanderPaquet"); /* DEBUG */
	dialoguer(DialogueDemanderPaquet, LONGUEUR(DialogueDemanderPaquet), NULL, fonctionRappelVide);
}

void autoPaquets() {
	// afficherChaineZ(" autoPaquets"); /* DEBUG */
	dialoguer(DialogueAutoPaquets, LONGUEUR(DialogueAutoPaquets), NULL, fonctionRappelVide);
}

uint8 obtenirCompaqStatusByte() {
	// afficherChaineZ(" getcsb"); /* DEBUG */
	
	attenteKbc();
	outb(PORT_KBC_COMMANDE, KBC_DEMMANDE_LECTURE_COMPAQ_STATUS_BYTE);
	
	// attenteLectureKbc();
	return inb(PORT_KBC_DONNEES);
}

void definirCompaqStatusByte(uint8 csb) {
	attenteKbc();
	outb(PORT_KBC_COMMANDE, KBC_DEMMANDE_ECRITURE_COMPAQ_STATUS_BYTE);
	
	attenteKbc();
	outb(PORT_KBC_DONNEES, csb);
}

void activerIrq12() {
	definirGestionnaireRequeteInterruption(LIGNE_IRQ_SOURIS, gestionnaireSourisPS2);
	activerLigneRequeteInterruption(LIGNE_IRQ_SOURIS);
	
	uint8 csb = obtenirCompaqStatusByte();
	// afficherEntierEnHexa(csb); afficherChaineZ(" "); /* DEBUG */
	csb |= 2; // Activer Irq 12
	csb &= ~0x20; // Désactiver l'horloge souris
	// afficherEntierEnHexa(csb); /* DEBUG */
	definirCompaqStatusByte(csb);
}

void initSourisPS2 (void** etat) {
	*etat = etatSourisPS2;
	
	etatSourisPS2->etapeDialogue = 0;
	etatSourisPS2->etatGestionnaireSourisPS2 = ETAT_GESTIONNAIRE_SOURIS_PS2_ATTENTE;
	
	etatSourisPS2->curseur_x = 1024/2;
	etatSourisPS2->curseur_y = 768/2;
	
	activerIrq12();
	
	autoPaquets();
	
	etatSourisPS2->couleur = 0xffffffff; /* DEBUG */
}

void deinitSourisPS2 (void** etat) {
	*etat = NULL;
}
