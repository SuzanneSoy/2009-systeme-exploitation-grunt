#include <module.h>
#include <types.h>
#include <pc/gdt/gdt.h>
#include <interfaceUtilisateur/console/console.h>

MODULE(Gdt);

static DescripteurSegment tableDescripteursSegment[] = {
	[0] = descripteurSegmentNULL,
	[1] = descripteurSegmentBasicFlatModel(SEGMENT_CODE),
	[2] = descripteurSegmentBasicFlatModel(SEGMENT_DONNEES)
};

void initGdt (void** etat) {
	*etat = etatGdt;
	
	etatGdt->tableDescripteursSegment = tableDescripteursSegment;
	etatGdt->registreGDTR.base = etatGdt->tableDescripteursSegment;
	etatGdt->registreGDTR.limite = sizeof (tableDescripteursSegment) - 1;
			
	asm volatile ("\
		lgdt %0 \n\
		ljmp %1, $label \n\
		label: \n\
		movw %2, %%ax \n\
		movw %%ax, %%ds \n\
		movw %%ax, %%es \n\
		movw %%ax, %%fs \n\
		movw %%ax, %%gs \n\
		movw %%ax, %%ss"
		: 
		: "m" (etatGdt->registreGDTR), "g" (8), "g" (16)
		: "memory", "eax"
		);
}

void deinitGdt (void** etat) {
	*etat = NULL;
}
