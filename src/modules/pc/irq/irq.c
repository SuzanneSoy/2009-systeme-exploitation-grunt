#include <module.h>
#include <types.h>
#include <pc/idt/idt.h>
#include <pc/io/io.h>
#include <pc/irq/irq.h>
#include <interfaceUtilisateur/console/console.h> /* DEBUG */

MODULE(Irq);

DEPENDANCE_MODULE(Irq, Idt);
DEPENDANCE_MODULE(Irq, Io);

extern GestionnaireRequeteInterruption tableFonctionsEnvoiFinInterruption[];
extern GestionnaireRequeteInterruption tableGestionnairesRequeteInterruption[];

void gestionnaireRequeteInterruptionVide() {
}

void initIrq (void** etat) {
	desactiverInterruptions();
	
	*etat = etatIrq;
	
	etatIrq->tableFonctionsEnvoiFinInterruption = tableFonctionsEnvoiFinInterruption;
	etatIrq->tableGestionnairesRequeteInterruption = tableGestionnairesRequeteInterruption;
	
	etatIrq->adresseVecteurInterruptionMaitre = 32;
	etatIrq->adresseVecteurInterruptionEsclave = 32 + 8;
	
	etatIrq->masqueMaitre = 0xff & (~(1 << 2)); /* connexion avec l'esclave activÃ©e */
	etatIrq->masqueEsclave = 0xff;
	
	etatIrq->ancienMasqueMaitre = inb(PORT_PIC_MAITRE_DONNEES);
	etatIrq->ancienMasqueEsclave = inb(PORT_PIC_ESCLAVE_DONNEES);
	
	
	etatIrq->ICW1_Maitre = (PicICW1){
		.ICW4_present = TRUE,
		.single = PIC_ICW1_CASCADE,
		.adi = PIC_ICW1_INTERVALLE_8,
		.ltim = PIC_ICW1_EDGE_TRIGGERED_MODE,
		.init = 1,
		._zero = 0
	};
	
	etatIrq->ICW2_Maitre = (PicICW2){
		._zero = 0,
		.adresseVecteurInterruption_7_3 = etatIrq->adresseVecteurInterruptionMaitre >> 3
	};
	
	etatIrq->ICW3_Maitre = ESCLAVE_CONNECTE_SUR_MAITRE_PATTE(2);
	
	etatIrq->ICW4_Maitre = (PicICW4){
		.microPM = PIC_ICW4_MODE_8086_8088,
		.autoEOI = FALSE,
		.tampon = PIC_ICW4_MODE_SANS_TAMPON,
		.specialFullyNestedMode = FALSE
	};
	
	
	etatIrq->ICW1_Esclave = etatIrq->ICW1_Maitre;
	
	etatIrq->ICW2_Esclave = (PicICW2){
		._zero = 0,
		.adresseVecteurInterruption_7_3 = etatIrq->adresseVecteurInterruptionEsclave >> 3
	};
	
	etatIrq->ICW3_Esclave = (PicICW3_Esclave){
		.patteConnexionMaitre = 2,
		._zero = 0
	};
	
	etatIrq->ICW4_Esclave = etatIrq->ICW4_Maitre;
	
	
	outb (PORT_PIC_MAITRE_COMMANDE,  etatIrq->ICW1_Maitre);
	outb (PORT_PIC_MAITRE_DONNEES,   etatIrq->ICW2_Maitre);
	outb (PORT_PIC_MAITRE_DONNEES,   etatIrq->ICW3_Maitre);
	outb (PORT_PIC_MAITRE_DONNEES,   etatIrq->ICW4_Maitre);
	outb (PORT_PIC_MAITRE_DONNEES,   etatIrq->masqueMaitre);

	outb (PORT_PIC_ESCLAVE_COMMANDE, etatIrq->ICW1_Esclave);
	outb (PORT_PIC_ESCLAVE_DONNEES,  etatIrq->ICW2_Esclave);
	outb (PORT_PIC_ESCLAVE_DONNEES,  etatIrq->ICW3_Esclave);
	outb (PORT_PIC_ESCLAVE_DONNEES,  etatIrq->ICW4_Esclave);
	outb (PORT_PIC_ESCLAVE_DONNEES,  etatIrq->masqueEsclave);
	
	int i;
	for (i = 0; i < 8; i++) {
		definirGestionnaireInterruption(etatIrq->adresseVecteurInterruptionMaitre + i, tableFonctionsEnvoiFinInterruption[i]);
	}
	
	for (i = 0; i < 8; i++)
		definirGestionnaireInterruption(etatIrq->adresseVecteurInterruptionEsclave + i, tableFonctionsEnvoiFinInterruption[i+8]);
	activerInterruptions();
}

void deinitIrq (void** etat) {
	*etat = NULL;
}

void definirGestionnaireRequeteInterruption(int ligne, GestionnaireRequeteInterruption gestionnaire) {
	desactiverInterruptions();
	
	etatIrq->tableGestionnairesRequeteInterruption[ligne] = gestionnaire;
	
	activerInterruptions();
}

void activerLigneRequeteInterruption(int ligne) {
	if (ligne < 8) {
		activerInterruption(etatIrq->adresseVecteurInterruptionMaitre + ligne);
		etatIrq->masqueMaitre &= ~(1 << (ligne & 0x07));
		outb (PORT_PIC_MAITRE_DONNEES,   etatIrq->masqueMaitre);
	} else {
		activerInterruption(etatIrq->adresseVecteurInterruptionEsclave + ligne - 8);
		etatIrq->masqueEsclave &= ~(1 << (ligne & 0x07));
		outb (PORT_PIC_ESCLAVE_DONNEES,  etatIrq->masqueEsclave);
	}
}

void desactiverLigneRequeteInterruption(int ligne) {
	if (ligne < 8) {
		desactiverInterruption(etatIrq->adresseVecteurInterruptionMaitre + ligne);
		etatIrq->masqueMaitre |= (1 << (ligne & 0x07));
		outb (PORT_PIC_MAITRE_DONNEES,   etatIrq->masqueMaitre);
	} else {
		desactiverInterruption(etatIrq->adresseVecteurInterruptionEsclave + ligne - 8);
		etatIrq->masqueEsclave |= (1 << (ligne & 0x07));
		outb (PORT_PIC_ESCLAVE_DONNEES,  etatIrq->masqueEsclave);
	}
}
