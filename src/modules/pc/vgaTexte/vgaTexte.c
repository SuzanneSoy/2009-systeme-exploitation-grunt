#include <module.h>
#include <types.h>
#include <interfaceUtilisateur/console/console.h>
#include <pc/vgaTexte/vgaTexte.h>

MODULE(VgaTexte);

DEPENDANCE_MODULE(VgaTexte, Console);

CouleurVgaTexte CouleursVersCouleurVgaTexte(Couleur couleurAv, Couleur couleurAr) {
	CouleurComposantes composantesAv = CAST_INT_TO_STRUCT(couleurAv, CouleurComposantes);
	CouleurComposantes composantesAr = CAST_INT_TO_STRUCT(couleurAr, CouleurComposantes);
	
	CouleurVgaTexte couleurVgaTexte;
	
	couleurVgaTexte.avClair = ((composantesAv.rouge + composantesAv.vert + composantesAv.bleu) > 3*128);
	couleurVgaTexte.avRouge = (composantesAv.rouge > 128);
	couleurVgaTexte.avVert = (composantesAv.vert > 128);
	couleurVgaTexte.avBleu = (composantesAv.bleu > 128);
	
	couleurVgaTexte._reserve = 0;
	couleurVgaTexte.arRouge = (composantesAr.rouge > 128);
	couleurVgaTexte.arVert = (composantesAr.vert > 128);
	couleurVgaTexte.arBleu = (composantesAr.bleu > 128);
	
	return couleurVgaTexte;
}

void vgaTexteAfficherCaractereCouleurPosition(char caractere, uint32 couleurAv, uint32 couleurAr, uint32 x, uint32 y) {
	etatVgaTexte->memoireVideo[x + y * etatVgaTexte->console.largeur] = (CaractereVgaTexte) {
		.caractere = caractere,
		.couleur   = CouleursVersCouleurVgaTexte(couleurAv, couleurAr)
	};
}

void initVgaTexte (void** etat) {
	*etat = etatVgaTexte;
	
	etatVgaTexte->memoireVideo = (CaractereVgaTexte*)0xb8000;
	
	etatVgaTexte->console.x = 0;
	etatVgaTexte->console.y = 0;
	etatVgaTexte->console.largeur = 80;
	etatVgaTexte->console.hauteur = 25;
	etatVgaTexte->console.fonctionAffichage = vgaTexteAfficherCaractereCouleurPosition;
	
	// definirConsoleActive(&etatVgaTexte->console);
}

void deinitVgaTexte (void** etat) {
	*etat = NULL;
}
