#include <module.h>
#include <types.h>
#include <pc/idt/idt.h>
#include <interfaceUtilisateur/console/console.h>

MODULE(Idt);

DEPENDANCE_MODULE(Idt, Gdt);

extern EnregistreurContexteInterruption tableEnregistreursContexteInterruption[];
extern GestionnaireInterruption tableGestionnairesInterruption[];

void gestionnaireInterruptionVide() {
}

void initIdt (void** etat) {
	*etat = etatIdt;
	
	etatIdt->interruptionsDesactivees = 0;
	desactiverInterruptions();
	
	etatIdt->nombreDescripteursInterruption = LONGUEUR(etatIdt->tableDescripteursInterruption);
	etatIdt->registreIDTR.base = etatIdt->tableDescripteursInterruption;
	etatIdt->registreIDTR.limite = sizeof (etatIdt->tableDescripteursInterruption) - 1;
	
	int i;
	for (i = 0; i < etatIdt->nombreDescripteursInterruption; i++)
		etatIdt->tableDescripteursInterruption[i] = (DescripteurInterruption){
			.offset_15_0 = (uint32)(tableEnregistreursContexteInterruption[i]) & 0xffff,
			.selecteurSegment = 1 << 3, /* Segment de code */
			
			._zero_a = 0,
			/* .type = 0,
			._un = 1,
			.taillePorte = 0,
			._zero_b = 0, */
			.type = 14,
			.niveauPrivilegeDescripteur = 0,
			.present = FALSE,
			.offset_31_16 = (((uint32)(tableEnregistreursContexteInterruption[i])) >> 16) & 0xffff
		};
	
	asm volatile ("lidt %0"
		:
		: "m" (etatIdt->registreIDTR)
		: "memory"
		);
	
	activerInterruptions();
}

void deinitIdt (void** etat) {
	*etat = NULL;
}

int desactiverInterruptions() {
	asm volatile ("cli");
	etatIdt->interruptionsDesactivees++;
	return 0;
}

int activerInterruptions() {
	if (etatIdt->interruptionsDesactivees <= 1) {
		etatIdt->interruptionsDesactivees = 0;
		asm volatile ("sti");
	} else {
		etatIdt->interruptionsDesactivees--;
	}
	return 0;
}

void definirGestionnaireInterruption(int numeroInterruption, GestionnaireInterruption gestionnaire) {
	desactiverInterruptions();
	
	tableGestionnairesInterruption[numeroInterruption] = gestionnaire;
	
	activerInterruptions();
}

void activerInterruption(int numeroInterruption) {
	desactiverInterruptions();
	etatIdt->tableDescripteursInterruption[numeroInterruption].present = TRUE;
	activerInterruptions();
}

void desactiverInterruption(int numeroInterruption) {
	desactiverInterruptions();
	etatIdt->tableDescripteursInterruption[numeroInterruption].present = FALSE;
	activerInterruptions();
}
