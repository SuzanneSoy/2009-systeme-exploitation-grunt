#include <module.h>
#include <types.h>
#include <math.h>
#include <pc/vesaGraphique/vesaGraphique.h>
#include <demarrage/multiboot/multiboot.h>
#include <interfaceUtilisateur/police/police.h>
#include <interfaceUtilisateur/console/console.h>

MODULE(VesaGraphique);

DEPENDANCE_MODULE(VesaGraphique, Multiboot);
DEPENDANCE_MODULE(VesaGraphique, Console);
DEPENDANCE_MODULE(VesaGraphique, Police);

extern EtatMultiboot* etatMultiboot;


void setPixel32 (uint32 x, uint32 y, uint32 couleur) {
	etatVesaGraphique->memoireVideo[x + 1024*y].rvb = couleur;
}

void ligne (uint32 x1, uint32 y1, uint32 x2, uint32 y2, uint32 couleur) {
	uint32 mdx2, mdy2, dx2, dy2;
	int32 err, dx, dy;
	
	setPixel32 (x2, y2, couleur);
	
	dx = x2 - x1;
	dy = y2 - y1;
	
	if (abs(dx) > abs(dy)) { // y++ ou y-- ou y=y à chaque tour
				err = - abs(dx);
				mdx2 = 2 * err;
				dy2 = 2 * abs(dy);
				
				for (; x1 != x2; x1 += sign(dx)) {
					setPixel32 (x1, y1, couleur);
					err += dy2;
					if (err >= 0) {
						err += mdx2;
						y1 += sign(dy);
					}
				}
	} else { // x++ ou x-- ou x=x à chaque tour
				err = - abs(dy);
				mdy2 = 2 * err;
				dx2 = 2 * abs(dx);
				
				for (; y1 != y2; y1 += sign(dy)) {
					setPixel32 (x1, y1, couleur);
					err += dx2;
					if (err >= 0) {
						err += mdy2;
						x1 += sign(dx);
					}
				}		
	}
}

void rectanglePlein (uint32 x1, uint32 y1, uint32 x2, uint32 y2, uint32 couleur) {
	uint32 y;
	for (; x1 <= x2; x1++)
		for (y = y1; y <= y2; y++)
			setPixel32(x1, y, couleur);
}

void rectangleContour (uint32 x1, uint32 y1, uint32 x2, uint32 y2, uint32 couleur) {
	uint32 x;
	for (x = x1; x <= x2; x++) {
		setPixel32(x, y1, couleur);
		setPixel32(x, y2, couleur);
	}
	
	for (; y1 <= y2; y1++) {
		setPixel32(x1, y1, couleur);
		setPixel32(x2, y1, couleur);
	}
}


void vesaGraphiqueAfficherCaractereCouleurPosition(char caractere, uint32 couleurAv, uint32 couleurAr, uint32 x, uint32 y) {
	policeAfficherCaractereCouleurPosition(caractere, couleurAv, couleurAr, x * 8, y * 15);
	caractere = caractere;
	couleurAv = couleurAv;
	couleurAr = couleurAr;
	x = x;
	y = y;
}


void initVesaGraphique (void** etat) {
	*etat = etatVesaGraphique;
	
	/* Passage en mode graphique. Actuellement effectué par grub (avec le patch pour VBE) */
	
	etatVesaGraphique->memoireVideo = etatMultiboot->InfoMultiboot->vbeModeInfo->linearAddress;
	
	etatVesaGraphique->console.x = 0;
	etatVesaGraphique->console.y = 0;
	etatVesaGraphique->console.largeur = 1024 / 8;
	etatVesaGraphique->console.hauteur = 768 / 15;
	etatVesaGraphique->console.fonctionAffichage = vesaGraphiqueAfficherCaractereCouleurPosition;
	
	definirConsoleActive(&etatVesaGraphique->console);
}

void deinitVesaGraphique (void** etat) {
	*etat = NULL;
}
