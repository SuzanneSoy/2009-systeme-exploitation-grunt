#include <module.h>
#include <types.h>
#include <algo/math/math.h>
#include <pc/irq/irq.h>
#include <pc/pit/pit.h>
#include <pc/io/io.h>

#include <interfaceUtilisateur/console/console.h> /* DEBUG */

MODULE(Pit);

DEPENDANCE_MODULE(Pit, Irq);
DEPENDANCE_MODULE(Pit, Io);
DEPENDANCE_MODULE(Pit, Math);
DEPENDANCE_MODULE(Pit, Console); /* DEBUG */

void gestionnaireRequeteInterruptionPit() {
	etatPit->gestionnairePit();
}

void gestionnairePitVide() {
}

void definirCompteurCanal(uint16 compteur, PitCanal canal) {
	uint8 haut = (compteur >> 8) & 0xff;
	uint8 bas = compteur & 0xff;
	int port = PORT_PIT_CANAUX + canal;
	/* TODO : lorsqu'on fait les outb avec un entier dans une variable
	 * pour le port, il y a un problÃ¨me. */
	port = port;
	
	if ((etatPit->modeAcces == PIT_OCTET_BAS) ||
	    (etatPit->modeAcces == PIT_OCTETS_HAUT_BAS))
		outb(PORT_PIT_CANAUX, bas);
	
	if ((etatPit->modeAcces == PIT_OCTET_HAUT) ||
	    (etatPit->modeAcces == PIT_OCTETS_HAUT_BAS))
		outb(PORT_PIT_CANAUX, haut);
}

void definirModeCanal(PitModeCanal mode, PitCanal canal) {
	PitCommandeMode commande;
	commande.bcd = FALSE;
	commande.mode = mode;
	commande.acces = etatPit->modeAcces;
	commande.canal = canal;
	
	outb(PORT_PIT_COMMANDE, commande);
}

/* freq en 1/1000 hz [~18000..FREQUENCE_PIT_KHZ] */
uint32 definirFrequenceCanal(uint32 freq, PitCanal canal) {
	uint32 diviseur = FREQUENCE_PIT_MILI_HZ / freq;
	
	if (diviseur > 65536) {
		return 0;
	} else if (diviseur == 65536) {
		definirCompteurCanal(0, canal);
		return FREQUENCE_PIT_MILI_HZ / 65536;
	} else if (diviseur == 0) {
		definirCompteurCanal(1, canal);
		return FREQUENCE_PIT_MILI_HZ;
	} else {
		definirCompteurCanal(diviseur, canal);
		return FREQUENCE_PIT_MILI_HZ / diviseur;
	}
}

/* delai en ns [1..10^8] */
uint32 definirDelaiCanal(uint32 delai, PitCanal canal) {
	//afficherEntierVirguleEnDecimal(delai, 9);
	uint64 fd = (uint64)FREQUENCE_PIT_MILI_HZ * (uint64)delai;
	Div64 r = div64 (fd, 1000000000000);
	uint64 diviseur = r.quotient;
	
	if (diviseur >= 65536) {
		definirCompteurCanal(0, canal);
		diviseur = 65536;
	} else if (diviseur == 0) {
		definirCompteurCanal(1, canal);
		diviseur = 1;
	} else {
		definirCompteurCanal(diviseur, canal);
	}
	
	Div64 delaiEffectif = div64(diviseur * 1000000000000L, FREQUENCE_PIT_MILI_HZ);
	
	return (uint32)delaiEffectif.quotient;
}

void definirGestionnairePit(GestionnairePit gestionnairePit) {
	etatPit->gestionnairePit = gestionnairePit;
}

void initPit (void** etat) {
	*etat = etatPit;
	
	etatPit->gestionnairePit = gestionnairePitVide;
	
	definirGestionnaireRequeteInterruption(LIGNE_IRQ_PIT, gestionnaireRequeteInterruptionPit);
	activerLigneRequeteInterruption(LIGNE_IRQ_PIT);
	
	etatPit->modeAcces = PIT_OCTETS_HAUT_BAS;
	definirModeCanal(PIT_MODE_GENERATEUR_FREQUENCE, 0);
	definirCompteurCanal(0, 0);
}

void deinitPit (void** etat) {
	*etat = NULL;
}
