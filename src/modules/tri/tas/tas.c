#include <module.h>
#include <types.h>
#include <tri/tas/tas.h>

MODULE(TriParTas);


void initTriParTas(void** etat) {
	*etat = NULL;
}

void deinitTriParTas(void** etat) {
	*etat = NULL;
}

void percoler(int racine, void* t, int taille, AccesseurIndex get, AccesseurEchanger echanger, Comparaison comparer) {
	int gauche = 2 * racine + 1;
	int droite = 2 * racine + 2;
	
	void* valracine;
	void* valgauche;
	
	while (droite < taille) {
		valracine = get(t, racine);
		valgauche = get(t, gauche);
		
		if (comparer(valracine, valgauche) < 0) {
			if (comparer(valgauche, get(t, droite)) < 0) {
				echanger(t, racine, droite);
				racine = droite;
			}
			else {
				echanger(t, racine, gauche);
				racine = gauche;
			}
		} else {
			if (comparer(valracine, get(t, droite)) < 0) {
				echanger(t, racine, droite);
				racine = droite;
			} else {
				return;
			}
		}
		
		gauche = 2 * racine + 1;
		droite = 2 * racine + 2;
	}
	
	if ((gauche < taille) && (comparer(get(t, racine), get(t, gauche)) < 0))
		echanger(t, racine, gauche);
}

void triParTas(void* t, int taille, AccesseurIndex get, AccesseurEchanger echanger, Comparaison comparer) {
	int i;
	for (i = (taille / 2) - 1; i >= 0; i--)
		percoler(i, t, taille, get, echanger, comparer);
	
	for (i = taille - 1; i > 0; i--) {
		echanger(t, i, 0);
		taille--;
		percoler(0, t, taille, get, echanger, comparer);
	}
}
